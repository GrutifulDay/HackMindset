botProtection.js + ipBlacklist.js = âŒ testy

backend
1. vyresit firefox - botProtection.js - stale se zobrazuje
2. vlozit a propojit fci - getUserIP.js
3. dodelat - checkBlacklist.js
4. rozmyslet zda pouziju XSS 
5. validace API 
6. dodelat server, endpoint, db pro dalsi API
7. UAParser misto User-Agent (starsi metoda)
8. nastaveni uozorneni o blokaci ip adresy 

frontend
1. zkratit funkce 
2. uklidit kod
3. pripravit kod pro UI
4. prehodit popup.js > content.js
5. dodelat UI 
6. musim dodelat fetch API - kdyz spadne jedno, nespadlo i to co je za tim
7. pocitani a ukladani like/dislike

db
1. nahrat data pro fetch 


ostatni
1. testovani
2. bezpecnost 
3. readme - napsat
4. upravit manifest.json 

= poslat frontend google, zverejnit 


import BlacklistedIP from "../models/BlacklistedIP.js";

// âŒ = ZAKOMENTUJ PRO TESTY âŒ 

// set se uklada do restartu serveru - je potreba fce pro kontrolu (loadBlacklistFromDB)
const blacklistedIPs = new Set();

// IP adresy, kterÃ© se nikdy neblokujÃ­ (lokÃ¡lnÃ­ prostÅ™edÃ­) âŒ 
// const ignoredIPs = new Set(["127.0.0.1", "::1", "::ffff:127.0.0.1"]);

// Middleware pro blokovani IP
export default function ipBlocker(req, res, next) {
  const clientIP = req.ip;

  // Ignor zname lokalni IP - âŒ 
  // if (ignoredIPs.has(clientIP)) {
  //   return next();
  // }

  // Zkontroluj, jestli je IP na blacklistu
  if (blacklistedIPs.has(clientIP)) {
    console.warn(`ğŸš¨ PÅ™Ã­stup zablokovÃ¡n pro IP: ${clientIP}`);
    console.log("ğŸ” DetekovanÃ¡ IP:", clientIP);
    return res.status(403).json({ error: "VaÅ¡e IP adresa byla zablokovÃ¡na." });
  }

  next();
}

// Funkce pro pridani IP do blacklistu   
export async function addToBlacklist(ip) {
  // âŒ 
  // if (ignoredIPs.has(ip)) {
  //   console.log(`â„¹ï¸ IP ${ip} je na seznamu vÃ½jimek (localhost), nebude blokovÃ¡na.`);
  //   return false;
  // }

  if (!blacklistedIPs.has(ip)) {
    blacklistedIPs.add(ip);
    console.warn(`ğŸ§¨ IP ${ip} pÅ™idÃ¡na do Setu`);

    try {
      const exists = await BlacklistedIP.findOne({ ip });
      if (!exists) {
        const newIP = new BlacklistedIP({ ip });
        await newIP.save();
        console.log(`ğŸ›‘ IP ${ip} uloÅ¾ena do databÃ¡ze`);
      } else {
        console.log(`âš ï¸ IP ${ip} uÅ¾ v databÃ¡zi existuje`);
      }
    } catch (err) {
      console.error("âŒ Chyba pÅ™i uklÃ¡dÃ¡nÃ­ IP do DB:", err.message);
    }

    return true;
  }

  return false; // uÅ¾ v Setu
}

// export async function loadBlacklistFromDB() {
//   try {
//     const allBlocked = await BlacklistedIP.find()
//     allBlocked.forEach(entry => blacklistedIPs.add(entry.ip))
//     console.log(`âœ… NaÄteno ${allBlocked.length} IP adres z DB do pamÄ›ti`);
//   } catch (err) {
//     console.error("âŒ Chyba pÅ™i naÄÃ­tÃ¡nÃ­ blacklistu z DB:", err.message);
//   }
// }
